---
#####################################################################################################################################################################################################
# Project:       Juniper
# Sub-Project:   JuniperCanopy
# Application:   juniper_canopy
# File Name:     ci.yml
# Author:        Paul Calnon
# Version:       0.13.0
#
# Date Created:  2025-11-03
# Last Modified: 2026-02-25
#
# License:       MIT License
# Copyright:     Copyright (c) 2024-2026 Paul Calnon
#
# Description:
#    GitHub Actions CI/CD Pipeline for Juniper Canopy CasCor NN Frontend
#    - Pre-commit hooks for code quality (black, isort, flake8, mypy, bandit)
#    - Unit tests with coverage enforcement
#    - Integration tests
#    - Security scanning (Gitleaks, Bandit SARIF, pip-audit)
#    - Proper failure handling (no continue-on-error for critical steps)
#    - Dependency caching for performance
#    - Migrated from conda to pip for CI portability (polyrepo Phase 5)
#
# References:
#    - CANOPY-P1-001: CI/CD Pipeline Setup
#    - Best practices: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions
#####################################################################################################################################################################################################

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - feature/**
      - fix/**
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  ENV_NAME: JuniperCanopy
  PYTHON_TEST_VERSION: "3.13"
  COVERAGE_FAIL_UNDER: "80"

jobs:
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Pre-commit: Code Quality Checks (runs across multiple Python versions)
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  pre-commit:
    name: Pre-commit (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Cache pre-commit hooks
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684  # v4.2.3
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Run pre-commit hooks
        env:
          # Skip local test hook in CI: it uses hardcoded conda path.
          # Coverage is enforced by the dedicated unit-tests job.
          SKIP: pytest-coverage
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Pre-commit Checks                   ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo "Note: pytest-coverage hook skipped in CI"
          echo "      (handled by dedicated unit-tests job with full environment)"
          pre-commit run --all-files --show-diff-on-failure

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Unit Tests: Run unit tests with coverage enforcement
  # Migrated from conda to pip for CI portability (polyrepo Phase 5)
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  unit-tests:
    name: Unit Tests + Coverage (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [pre-commit]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 1

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install dependencies
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Install Dependencies                ║"
          echo "║       Python ${{ matrix.python-version }}                                        ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          python -m pip install --upgrade pip
          # Install CPU-only PyTorch (CI doesn't need CUDA)
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          # Install all other CI dependencies
          pip install -r conf/requirements_ci.txt
          # Install project as editable so source-tree path resolution works
          pip install -e .

      - name: Create required directories
        run: |
          mkdir -p logs src/logs reports/junit reports/coverage reports/htmlcov

      - name: Run Unit Tests with Coverage Gate
        env:
          CASCOR_BACKEND_AVAILABLE: 0
          RUN_SERVER_TESTS: 0
          ENABLE_SLOW_TESTS: 0
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Unit Tests (Fast Only)              ║"
          echo "╚════════════════════════════════════════════════════════════╝"

          cd src
          python -m pytest \
            -m "not requires_cascor and not requires_server and not slow" \
            tests/ \
            --verbose \
            --timeout=60 \
            --maxfail=5 \
            --junitxml=../reports/junit/junit-unit.xml \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml:../reports/coverage.xml \
            --cov-report=html:../reports/htmlcov \
            --cov-fail-under=${COVERAGE_FAIL_UNDER}

      - name: Upload Coverage Artifacts
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        if: always()
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: |
            reports/coverage.xml
            reports/htmlcov/
          retention-days: 30

      - name: Upload Test Results
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        if: always()
        with:
          name: unit-test-results-py${{ matrix.python-version }}
          path: reports/junit/
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Integration Tests: Run integration tests (PRs and main/develop pushes)
  # Migrated from conda to pip for CI portability (polyrepo Phase 5)
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event_name == 'pull_request' || github.ref_name == 'main' || github.ref_name == 'develop'

    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 1

      - name: Set up Python ${{ env.PYTHON_TEST_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: ${{ env.PYTHON_TEST_VERSION }}
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -r conf/requirements_ci.txt
          pip install -e .

      - name: Create required directories
        run: |
          mkdir -p logs src/logs reports/junit

      - name: Run Integration Tests (Fast Only)
        env:
          CASCOR_BACKEND_AVAILABLE: 0
          RUN_SERVER_TESTS: 0
          ENABLE_SLOW_TESTS: 0
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Integration Tests (Fast Only)       ║"
          echo "╚════════════════════════════════════════════════════════════╝"

          cd src
          python -m pytest \
            -m "integration and not requires_cascor and not requires_server and not slow" \
            tests/integration \
            --verbose \
            --timeout=120 \
            --maxfail=3 \
            --junitxml=../reports/junit/junit-integration.xml

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        if: always()
        with:
          name: integration-test-results
          path: reports/junit/
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Build: Build distribution packages
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python ${{ env.PYTHON_TEST_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: ${{ env.PYTHON_TEST_VERSION }}
          cache: pip

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build

      - name: Build distribution packages
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Build Distribution                  ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          python -m build --sdist --wheel

      - name: Verify build artifacts
        run: |
          echo "Checking build artifacts..."
          ls -la dist/
          test -f dist/*.tar.gz || (echo "::error::Source distribution not found" && exit 1)
          test -f dist/*.whl || (echo "::error::Wheel not found" && exit 1)
          echo "Build artifacts verified successfully"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        with:
          name: dist-packages
          path: dist/
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Security: Run security scans (Gitleaks, Bandit, pip-audit)
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  security:
    name: Security Scans
    runs-on: ubuntu-latest
    needs: [pre-commit]

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2
        with:
          fetch-depth: 0

      - name: Run Gitleaks (Secrets Detection)
        uses: gitleaks/gitleaks-action@ff98106e4c7b2bc287b24eaf42907196329070c7  # v2.3.9
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          fail: true

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: "3.13"
          cache: pip

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit pip-audit

      - name: Create reports directory
        run: mkdir -p reports/security

      - name: Run Bandit (SAST) -> SARIF
        id: bandit
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Bandit Security Scan                ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          bandit -r src -f sarif -o reports/security/bandit.sarif -c .bandit.yml 2>&1 || BANDIT_EXIT=$?
          bandit -r src -f txt -o reports/security/bandit.txt -c .bandit.yml 2>&1 || true
          if [ "${BANDIT_EXIT:-0}" -ne 0 ]; then
            echo "::warning::Bandit found security issues. Review the SARIF report."
            echo "bandit_found_issues=true" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::Bandit scan passed - no security issues found."
            echo "bandit_found_issues=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Bandit SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@48ab28a6f5dbc2a99bf1e0131198dd8f1df78169  # v3.28.0
        if: always()
        with:
          sarif_file: reports/security/bandit.sarif
        continue-on-error: true

      - name: Run pip-audit (Dependency Vulnerabilities)
        id: pip_audit
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - pip-audit Dependency Scan           ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          pip install dash fastapi uvicorn plotly numpy scipy
          pip freeze > reports/security/pip-freeze.txt
          pip-audit -r reports/security/pip-freeze.txt --output reports/security/pip-audit.txt 2>&1 || PIP_AUDIT_EXIT=$?
          if [ "${PIP_AUDIT_EXIT:-0}" -ne 0 ]; then
            echo "::error::pip-audit found vulnerabilities in dependencies!"
            echo "vulnerabilities_found=true" >> "$GITHUB_OUTPUT"
            cat reports/security/pip-audit.txt
            exit 1
          else
            echo "::notice::pip-audit passed - no known vulnerabilities found."
            echo "vulnerabilities_found=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload Security Reports
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        if: always()
        with:
          name: security-reports
          path: reports/security/
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Dependency Documentation: Generate pip, conda, and other dependency records
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  dependency-docs:
    name: Dependency Documentation
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Checkout Code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683  # v4.2.2

      - name: Set up Python ${{ env.PYTHON_TEST_VERSION }}
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065  # v5.6.0
        with:
          python-version: ${{ env.PYTHON_TEST_VERSION }}
          cache: pip

      - name: Set up Conda (Miniforge)
        uses: conda-incubator/setup-miniconda@fc2d68f6413eb2d87b895e92f8584b5b94a10167  # v3.3.0
        with:
          miniforge-version: latest
          auto-activate-base: true
          python-version: ${{ env.PYTHON_TEST_VERSION }}

      - name: Install project dependencies
        shell: bash -l {0}
        run: |
          python -m pip install --upgrade pip
          pip install torch --index-url https://download.pytorch.org/whl/cpu
          pip install -r conf/requirements_ci.txt
          pip install -e .

      - name: Generate Dependency Documentation
        shell: bash -l {0}
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Dependency Documentation            ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          bash scripts/generate_dep_docs.sh

      - name: Validate Generated YAML
        shell: bash -l {0}
        run: |
          python -c "
          import yaml
          with open('conf/conda_environment_ci.yaml') as f:
              data = yaml.safe_load(f)
          deps = data.get('dependencies', [])
          print(f'  Validated: {len(deps)} dependencies in conda_environment_ci.yaml')
          assert len(deps) > 0, 'No dependencies found — generation may have failed'
          "

      - name: Upload Dependency Documentation
        uses: actions/upload-artifact@65c4c4a1ddee5b72f698fdd19549f0f0fb45cf08  # v4.6.0
        if: always()
        with:
          name: dependency-docs
          path: |
            conf/requirements_ci.txt
            conf/requirements_ci_*.txt
            conf/conda_environment_ci.yaml
            conf/conda_environment_ci_*.yaml
          retention-days: 90

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Required Checks Aggregator: Final quality gate
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  required-checks:
    name: Quality Gate
    runs-on: ubuntu-latest
    if: always()
    needs: [pre-commit, unit-tests, integration-tests, security, build, dependency-docs]

    steps:
      - name: Check Quality Gate Status
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Quality Gate Status                 ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Pre-commit:        ${{ needs.pre-commit.result }}"
          echo "Unit Tests:        ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Security:          ${{ needs.security.result }}"
          echo "Build:             ${{ needs.build.result }}"
          echo "Dependency Docs:   ${{ needs.dependency-docs.result }}"
          echo ""

          if [[ "${{ needs.pre-commit.result }}" != "success" ]]; then
            echo "::error::Pre-commit checks failed"
            exit 1
          fi

          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "::error::Unit tests failed"
            exit 1
          fi

          if [[ "${{ needs.security.result }}" == "failure" ]]; then
            echo "::error::Security scans failed"
            exit 1
          fi

          if [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "::error::Integration tests failed"
            exit 1
          fi

          # Dependency docs: failure = error, skipped = OK (non-blocking)
          if [[ "${{ needs.dependency-docs.result }}" == "failure" ]]; then
            echo "::error::Dependency documentation generation failed"
            exit 1
          fi

          echo "::notice::Quality Gate PASSED ✓"

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Notify: Build status notification
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  notify:
    name: Build Notification
    runs-on: ubuntu-latest
    needs: [required-checks]
    if: always()

    steps:
      - name: Build Status Summary
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Build Complete                      ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "========== CI/CD Pipeline Summary =============================="
          echo "Status:   ${{ needs.required-checks.result }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Branch:   ${{ github.ref_name }}"
          echo "Commit:   ${{ github.sha }}"
          echo "Actor:    ${{ github.actor }}"
          echo "Event:    ${{ github.event_name }}"
          echo "================================================================"

---
#####################################################################################################################################################################################################
# Project:       Juniper
# Sub-Project:   JuniperCanopy
# Application:   juniper_canopy
# File Name:     ci.yml
# Author:        Paul Calnon
# Version:       0.11.0
#
# Date Created:  2025-11-03
# Last Modified: 2026-01-31
#
# License:       MIT License
# Copyright:     Copyright (c) 2024-2026 Paul Calnon
#
# Description:
#    GitHub Actions CI/CD Pipeline for Juniper Canopy CasCor NN Frontend
#    - Pre-commit hooks for code quality (black, isort, flake8, mypy, bandit)
#    - Unit tests with coverage enforcement
#    - Integration tests
#    - Security scanning (Gitleaks, Bandit SARIF, pip-audit)
#    - Proper failure handling (no continue-on-error for critical steps)
#    - Dependency caching for performance
#
# References:
#    - CANOPY-P1-001: CI/CD Pipeline Setup
#    - Best practices: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions
#####################################################################################################################################################################################################

name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
      - feature/**
      - fix/**
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  ENV_NAME: JuniperCanopy
  PYTHON_TEST_VERSION: "3.14"
  COVERAGE_FAIL_UNDER: "50"

jobs:
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Pre-commit: Code Quality Checks (runs across multiple Python versions)
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  pre-commit:
    name: Pre-commit (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip

      - name: Install pre-commit
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit

      - name: Cache pre-commit hooks
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-${{ matrix.python-version }}-

      - name: Run pre-commit hooks
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Pre-commit Checks                   ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          pre-commit run --all-files --show-diff-on-failure

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Unit Tests: Run unit tests with coverage enforcement
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  unit-tests:
    name: Unit Tests + Coverage (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    needs: [pre-commit]
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.11", "3.12", "3.13", "3.14"]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Free disk space
        run: |
          echo "Freeing disk space before conda setup..."
          df -h
          sudo rm -rf /usr/games /usr/share/php* /usr/share/julia*
          sudo rm -rf /usr/local/julia* /usr/local/gradle* /usr/local/apache-maven*
          sudo rm -rf /usr/local/kotlinc /usr/local/bison
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet
          sudo rm -rf /opt/microsoft /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go
          df -h

      - name: Set up Miniforge (mamba)
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          use-mamba: true
          auto-activate-base: false

      - name: Cache conda packages
        uses: actions/cache@v4
        with:
          path: |
            ~/miniforge3/pkgs
            ~/miniconda3/pkgs
            ~/.conda/pkgs
          key: conda-pkgs-${{ runner.os }}-${{ hashFiles('conf/conda_environment_ci.yaml') }}
          restore-keys: |
            conda-pkgs-${{ runner.os }}-

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('conf/requirements_ci.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Create conda environment
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Create Conda Environment            ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          mamba env create -n "${ENV_NAME}" -f conf/conda_environment_ci.yaml python=${{ matrix.python-version }} || \
            mamba env update -n "${ENV_NAME}" -f conf/conda_environment_ci.yaml
          conda activate "${ENV_NAME}"
          python --version
          pip --version

      - name: Install additional dependencies
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          conda activate "${ENV_NAME}"
          pip install -r conf/requirements_ci.txt
          pip install pytest pytest-cov pytest-timeout pytest-xdist coverage[toml]

      - name: Create required directories
        run: |
          mkdir -p logs src/logs reports/junit reports/coverage

      - name: Run Unit Tests with Coverage Gate
        shell: bash -l {0}
        env:
          CASCOR_BACKEND_AVAILABLE: 0
          RUN_SERVER_TESTS: 0
          ENABLE_SLOW_TESTS: 0
        run: |
          set -euxo pipefail
          conda activate "${ENV_NAME}"

          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Unit Tests (Fast Only)              ║"
          echo "╚════════════════════════════════════════════════════════════╝"

          cd src
          python -m pytest \
            -m "not requires_cascor and not requires_server and not slow" \
            tests/ \
            --verbose \
            --timeout=60 \
            --maxfail=5 \
            --junitxml=../reports/junit/junit-unit.xml \
            --cov=. \
            --cov-report=term-missing \
            --cov-report=xml:../reports/coverage/coverage.xml \
            --cov-report=html:../reports/coverage/htmlcov \
            --cov-fail-under=${COVERAGE_FAIL_UNDER}

      - name: Upload Coverage Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-py${{ matrix.python-version }}
          path: |
            reports/coverage/coverage.xml
            reports/coverage/htmlcov/
          retention-days: 30

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-py${{ matrix.python-version }}
          path: reports/junit/junit-unit.xml
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Integration Tests: Run integration tests (PRs and main/develop pushes)
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]
    if: github.event_name == 'pull_request' || github.ref_name == 'main' || github.ref_name == 'develop'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Free disk space
        run: |
          echo "Freeing disk space before conda setup..."
          df -h
          sudo rm -rf /usr/games /usr/share/php* /usr/share/julia*
          sudo rm -rf /usr/local/julia* /usr/local/gradle* /usr/local/apache-maven*
          sudo rm -rf /usr/local/kotlinc /usr/local/bison
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet
          sudo rm -rf /opt/microsoft /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL /opt/hostedtoolcache/go
          df -h

      - name: Set up Miniforge (mamba)
        uses: conda-incubator/setup-miniconda@v3
        with:
          miniforge-version: latest
          use-mamba: true
          auto-activate-base: false

      - name: Cache conda packages
        uses: actions/cache@v4
        with:
          path: |
            ~/miniforge3/pkgs
            ~/miniconda3/pkgs
            ~/.conda/pkgs
          key: conda-pkgs-${{ runner.os }}-${{ hashFiles('conf/conda_environment_ci.yaml') }}
          restore-keys: |
            conda-pkgs-${{ runner.os }}-

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('conf/requirements_ci.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Create conda environment
        shell: bash -l {0}
        run: |
          set -euxo pipefail
          mamba env create -n "${ENV_NAME}" -f conf/conda_environment_ci.yaml python=${{ env.PYTHON_TEST_VERSION }} || \
            mamba env update -n "${ENV_NAME}" -f conf/conda_environment_ci.yaml
          conda activate "${ENV_NAME}"
          pip install -r conf/requirements_ci.txt
          pip install pytest pytest-timeout pytest-xdist

      - name: Create required directories
        run: |
          mkdir -p logs src/logs reports/junit

      - name: Run Integration Tests (Fast Only)
        shell: bash -l {0}
        env:
          CASCOR_BACKEND_AVAILABLE: 0
          RUN_SERVER_TESTS: 0
          ENABLE_SLOW_TESTS: 0
        run: |
          set -euxo pipefail
          conda activate "${ENV_NAME}"

          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Integration Tests (Fast Only)       ║"
          echo "╚════════════════════════════════════════════════════════════╝"

          cd src
          python -m pytest \
            -m "integration and not requires_cascor and not requires_server and not slow" \
            tests/integration \
            --verbose \
            --timeout=120 \
            --maxfail=3 \
            --junitxml=../reports/junit/junit-integration.xml

      - name: Upload Integration Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results
          path: reports/junit/junit-integration.xml
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Security: Run security scans (Gitleaks, Bandit, pip-audit)
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  security:
    name: Security Scans
    runs-on: ubuntu-latest
    needs: [pre-commit]

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks (Secrets Detection)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          fail: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit pip-audit

      - name: Create reports directory
        run: mkdir -p reports/security

      - name: Run Bandit (SAST) -> SARIF
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Bandit Security Scan                ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          bandit -r src -f sarif -o reports/security/bandit.sarif || true

      - name: Upload Bandit SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: reports/security/bandit.sarif
        continue-on-error: true

      - name: Run pip-audit (Dependency Vulnerabilities)
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - pip-audit Dependency Scan           ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          pip install dash fastapi uvicorn plotly numpy scipy
          pip freeze > reports/security/pip-freeze.txt
          pip-audit -r reports/security/pip-freeze.txt || echo "::warning::Vulnerabilities found in dependencies"

      - name: Upload Security Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: reports/security/
          retention-days: 30

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Required Checks Aggregator: Final quality gate
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  required-checks:
    name: Quality Gate
    runs-on: ubuntu-latest
    if: always()
    needs: [pre-commit, unit-tests, integration-tests, security]

    steps:
      - name: Check Quality Gate Status
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Quality Gate Status                 ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "Pre-commit:        ${{ needs.pre-commit.result }}"
          echo "Unit Tests:        ${{ needs.unit-tests.result }}"
          echo "Integration Tests: ${{ needs.integration-tests.result }}"
          echo "Security:          ${{ needs.security.result }}"
          echo ""

          # Pre-commit and unit-tests MUST pass
          if [[ "${{ needs.pre-commit.result }}" != "success" ]]; then
            echo "::error::Pre-commit checks failed"
            exit 1
          fi

          if [[ "${{ needs.unit-tests.result }}" != "success" ]]; then
            echo "::error::Unit tests failed"
            exit 1
          fi

          # Security should pass (but SARIF upload failures are allowed)
          if [[ "${{ needs.security.result }}" == "failure" ]]; then
            echo "::error::Security scans failed"
            exit 1
          fi

          # Integration tests: failure = error, skipped = OK (for feature branches)
          if [[ "${{ needs.integration-tests.result }}" == "failure" ]]; then
            echo "::error::Integration tests failed"
            exit 1
          fi

          echo "::notice::Quality Gate PASSED ✓"

  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  # Notify: Build status notification
  # ═══════════════════════════════════════════════════════════════════════════════════════════════
  notify:
    name: Build Notification
    runs-on: ubuntu-latest
    needs: [required-checks]
    if: always()

    steps:
      - name: Build Status Summary
        run: |
          echo "╔════════════════════════════════════════════════════════════╗"
          echo "║       Juniper Canopy - Build Complete                      ║"
          echo "╚════════════════════════════════════════════════════════════╝"
          echo ""
          echo "========== CI/CD Pipeline Summary =============================="
          echo "Status:   ${{ needs.required-checks.result }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Branch:   ${{ github.ref_name }}"
          echo "Commit:   ${{ github.sha }}"
          echo "Actor:    ${{ github.actor }}"
          echo "Event:    ${{ github.event_name }}"
          echo "================================================================"

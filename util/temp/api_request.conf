#!/usr/bin/env bash
###########################################################################################################################################
# Script Name:  api_request.conf
# Author Name:  Paul Calnon
# Modify Date:  2025-11-21
# Description:  Define Script Constants for api_request.bash: script to send request to api endpoint and store results
###########################################################################################################################################
# Notes:
#     Warning:
#         This config file is sourced by api_request.bash script.
#
#     API Endpoints:
#         Remote: https://api.close.com/buildwithus
#         Local http://127.0.0.1:8050/api/metrics
###########################################################################################################################################


###########################################################################################################################################
# Define High Level Script Constants
set -eE -o functrace

export TRUE="0"
export FALSE="1"

export DEBUG="${TRUE}"
# export DEBUG="${FALSE}"


###########################################################################################################################################
# Only Source this conf file Once
if [[ "${API_REQUEST_CONF_SOURCED}" != "${TRUE}" ]]; then
    export API_REQUEST_CONF_SOURCED="${TRUE}"
else
    log_warning "api_request.conf already sourced.  Skipping re-source."
    return "${TRUE}"
fi


###########################################################################################################################################
# Setup Environment for logging line numbers and function names
export SCRIPT_NAME_ID="1"
export LINE_NO_ID="0"
export FUNC_NAME_ID="1"


###########################################################################################################################################
# Define Script Constants for Shell Environment
# export VERBOSITY="0"              # Just do the things.
export VERBOSITY="1"                # What's going on?
# export VERBOSITY="2"              # Tell me more! (Some TLS spew)
# export VERBOSITY="3"              # Show me All The Things!! (All the TLS spew)

export SUCCESS="${FALSE}"           # It's where we start

# export LOCAL="${TRUE}"            # Keeping in on the box: Local Endpoint: http://127.0.0.1:8050/api/metrics
export LOCAL="${FALSE}"             # Think outside the box: Remote Endpoint: https://api.close.com/buildwithus/
export REMOTE="$(( (LOCAL+1)%2 ))"  # Remote: Umm, the opposite of Local.


###########################################################################################################################################
# Define script local env constants
CALLING_SCRIPT_PATH="$(realpath "${BASH_SOURCE[${SCRIPT_NAME_ID}]}")"
CALLING_SCRIPT_NAME="$(basename "${CALLING_SCRIPT_PATH}")"

CURRENT_SCRIPT_PATH="$(realpath "${BASH_SOURCE[$(( SCRIPT_NAME_ID - 1 ))]}")"
SCRIPT_NAME="$(basename "${CURRENT_SCRIPT_PATH}")"

export CLOSE_DIR="$(dirname "${CURRENT_SCRIPT_PATH}")"


###########################################################################################################################################
# Define File Extension Constants
export BASH_EXT=".bash"
export CONF_EXT=".conf"
export JSON_EXT=".json"
export OUT_EXT=".out"
export RSP_EXT="${JSON_EXT}"


###########################################################################################################################################
# Initialize logging functions
CLOSE_LOGGING_FILENAME_ROOT="close_logging"
export INIT_CLOSE_LOGGING_FILENAME="${CLOSE_LOGGING_FILENAME_ROOT}${CONF_EXT}"
export INIT_CLOSE_LOGGING="${CLOSE_DIR}/${INIT_CLOSE_LOGGING_FILENAME}"

source "${INIT_CLOSE_LOGGING}"
log_debug "Loaded ${INIT_CLOSE_LOGGING_FILENAME} for ${CALLING_SCRIPT_NAME}"


###########################################################################################################################################
# Define Script File Suffix and Extension Constants
FILENAME_ROOT_DEFAULT="close_buildwithus"
export FILE_ROOT_DEFAULT="${CLOSE_DIR}/${FILENAME_ROOT_DEFAULT}"

export RSP_FILENAME_SUFFIX="rsp"
export HASH_FILENAME_SUFFIX="hash"

export JSON_FILE=""
export OUT_FILE=""
export RESPONSE_FILE=""


###########################################################################################################################################
# Define Script API Request Constants
export REQ_TYPE_GET="GET"
export REQ_TYPE_POST="POST"
export REQ_TYPE="${REQ_TYPE_GET}"

export VERBOSE="-$(head -c "${VERBOSITY}" < /dev/zero | tr '\0' 'v')"

export GET_HEADER="-H 'accept: application/json'"
export POST_HEADER="-H 'Content-Type: application/json; charset=utf-8'"

if (( LOCAL == TRUE  )); then
    REQ_PROT="http://"
    REQ_HOST="127.0.0.1"
    REQ_PORT=":8050"
    REQ_PATH="api/metrics"
elif (( REMOTE == TRUE )); then
    REQ_PROT="https://"
    REQ_HOST="api.close.com"
    REQ_PORT=""
    REQ_PATH="buildwithus/"
else
    log_error "Not local? Not remote? Hard nope."
fi

export REQ_PROT
export REQ_HOST
export REQ_PORT
export REQ_PATH


###########################################################################################################################################
# Initialize variables that are assumed to exist
export HASHED_TRAITS_ARRAY=""
export HASHED_TRAITS_LIST=""
export REQ_URL=""
export CURL_PARAMS=""
export CURL_CMD=""
export HEADER=""


###########################################################################################################################################
# Reset script name to calling script
log_debug "Resetting script name: ${SCRIPT_NAME} back to calling script: ${CALLING_SCRIPT_NAME}"
export SCRIPT_NAME="${CALLING_SCRIPT_NAME}"

#!/usr/bin/env bash
#####################################################################################################################################################################################################
# Project:       Juniper
# Sub-Project:   JuniperCanopy
# Application:   juniper_canopy
# Purpose:       Monitoring and Diagnostic Frontend for Cascade Correlation Neural Network
#
# Author:        Paul Calnon
# Version:       1.0.0
# File Name:     logging.conf
# File Path:     <Project>/<Sub-Project>/<Application>/conf/
#
# Date:          2025-11-21
# Last Modified: 2025-12-19
#
# License:       MIT License
# Copyright:     Copyright (c) 2024,2025,2026 Paul Calnon
#
# Description:
#     This script is used to perform leveled logging for the JuniperCanopy util scripts.
#
#####################################################################################################################################################################################################
# Notes:
#     WARNING:  This config file is sourced by the config files for the api_request.bash and launch_close.bash scripts.
#
#     IMPORTANT NOTE:  Don't add check for re-sourcing this file; it breaks all the things.  Control is an illusion, man; just let it happen.  The dude abides.
#     IMPORTANT NOTE:  Colors are defined in the sourced config file: log_colors.conf
#
#     This script functions as a config file and is used to perform leveled logging for the Close scripts.
#     The supported logging levels are TRACE, VERBOSE, DEBUG, INFO, WARNING, ERROR, CRITICAL, and FATAL.
#
#     Logging Levels:
#         - The TRACE level is only logged if the log level variable is set to a value <= TRACE_LEVEL, returns 0
#         - The VERBOSE level is only logged if the log level variable is set to a value <= VERBOSE_LEVEL, returns 0
#         - The DEBUG level is only logged if the log level variable is set to a value <= DEBUG_NUM or if the DEBUG environment variable is set to TRUE, returns 0
#         - The INFO level is always logged if the log level variable is set to a value <= INFO_NUM or if the DEBUG environment variable is set to TRUE, returns 0
#         - The WARNING level is always logged if the log level variable is set to a value <= WARNING_NUM or if the DEBUG environment variable is set to TRUE, returns 0
#         - The ERROR level is always logged and the script if the log level variable is set to a value <= ERROR_NUM or if the DEBUG environment variable is set to TRUE, returns 1
#         - The CRITICAL level is always logged if the log level variable is set to a value <= CRITICAL_NUM or if the DEBUG environment variable is set to TRUE, exits with 1
#         - The FATAL level is always logged if the log level variable is set to a value <= FATAL_NUM or if the DEBUG environment variable is set to TRUE, exits with 1
#
#####################################################################################################################################################################################################
# References:
#
#####################################################################################################################################################################################################
# TODO :
#
#####################################################################################################################################################################################################
# COMPLETED:
#
#####################################################################################################################################################################################################


#####################################################################################################################################################################################################
# Define General Logging Constants
#####################################################################################################################################################################################################
TRUE="0"
FALSE="1"

# DEBUG="${TRUE}"
DEBUG="${FALSE}"

TAB_SIZE="4"


#####################################################################################################################################################################################################
# Define Available Logging Levels
#     NOTE: These need to be exported so that util functions can set their own log levels
#####################################################################################################################################################################################################
export TRACE_LEVEL=0
export VERBOSE_LEVEL=1
export DEBUG_LEVEL=2
export INFO_LEVEL=3
export WARNING_LEVEL=4
export ERROR_LEVEL=5
export CRITICAL_LEVEL=6
export FATAL_LEVEL=7


export DEFAULT_LEVEL="${TRACE_LEVEL}"       # Set default log level to TRACE
# export DEFAULT_LEVEL="${VERBOSE_LEVEL}"   # Set default log level to VERBOSE
# export DEFAULT_LEVEL="${DEBUG_LEVEL}"     # Set default log level to DEBUG
# export DEFAULT_LEVEL="${INFO_LEVEL}"      # Set default log level to INFO
# export DEFAULT_LEVEL="${WARNING_LEVEL}"   # Set default log level to WARNING
# export DEFAULT_LEVEL="${ERROR_LEVEL}"     # Set default log level to ERROR
# export DEFAULT_LEVEL="${CRITICAL_LEVEL}"  # Set default log level to CRITICAL
# export DEFAULT_LEVEL="${FATAL_LEVEL}"     # Set default log level to FATAL


#####################################################################################################################################################################################################
# Define constants for error logging termination settings
#####################################################################################################################################################################################################
# Set Default Return Value by Logging Level Function
EXIT_TRACE="${TRUE}"
EXIT_VERBOSE="${TRUE}"
EXIT_DEBUG="${TRUE}"
EXIT_INFO="${TRUE}"
EXIT_WARNING="${TRUE}"
EXIT_ERROR="${FALSE}"
EXIT_CRITICAL="${FALSE}"
EXIT_FATAL="${FALSE}"

# Flag to determine if logging an error terminates this application process.
TERM_ERROR="${FALSE}"
TERM_CRITICAL="${TRUE}"
TERM_FATAL="${TRUE}"


#####################################################################################################################################################################################################
# Define Log Enviornment File Constants
#####################################################################################################################################################################################################
SCRIPT_FILE_PATH="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
PROJ_PATH="$(dirname "${SCRIPT_FILE_PATH}")"

# Define Logging file
LOGS_PATH="${PROJ_PATH}/${LOGS_DIR_NAME}"
LOG_FILE_NAME="${APP_NAME}.${LOGS_EXT}"
export LOG_FILE="${LOGS_PATH}/${LOG_FILE_NAME}"


#####################################################################################################################################################################################################
# Clear logs only if in Debug mode
#####################################################################################################################################################################################################
if [[ "${TRUNCATED_LOGS}" != "${TRUE}" ]]; then
    [[ "${DEBUG}" == "${TRUE}" ]] && cat /dev/null > "${LOG_FILE}"
    export TRUNCATED_LOGS="${TRUE}"
fi


#####################################################################################################################################################################################################
# Define and Source Logging Colors Config file for sourcing
#####################################################################################################################################################################################################
CONF_EXT="conf"
CONF_DIR_NAME="${CONF_EXT}"
CONF_PATH="${PROJ_PATH}/${CONF_DIR_NAME}"
LOG_COLORS_FILE_NAME_PREFIX="log_colors"
LOG_COLORS_FILE_NAME="${LOG_COLORS_FILE_NAME_PREFIX}.${CONF_EXT}"
export LOG_COLORS_FILE="${CONF_PATH}/${LOG_COLORS_FILE_NAME}"

if [[ "${DEBUG}" == "${TRUE}" ]]; then
    [[ "${TRACE_LEVEL}" != "" ]] && log_trace "Running the Log Colors Conf file: \"${LOG_COLORS_FILE}\""
    export DEBUG
    if [[ -f "${LOG_COLORS_FILE}" ]]; then
        source "${LOG_COLORS_FILE}"
    else
        echo "Log Colors Conf file not found: ${LOG_COLORS_FILE}"
        return "${FALSE}"
    fi
else
    [[ "${TRACE_LEVEL}" != "" ]] && log_trace"Sourcing the Log Colors Conf file"
    [[ -f "${LOG_COLORS_FILE}" ]] && source "${LOG_COLORS_FILE}" || return "${FALSE}"
fi
[[ "${TRACE_LEVEL}" != "" ]] i&& log_trace "Completed calling the Log Colors Conf file"


#####################################################################################################################################################################################################
# Define Constants for Logging Level Colors
#####################################################################################################################################################################################################
export COLOR_TRACE="${BLACK_BOLD_DARK}"
[[ "${DEBUG}" == "${TRUE}" ]] && printf "%bColor Trace: BLACK_BOLD_DARK%b\n" "${COLOR_TRACE}" "${RESET}"
export COLOR_VERBOSE="${BLACK_BOLD}"
[[ "${DEBUG}" == "${TRUE}" ]] && printf "%bColor Verbose: BLACK_BOLD%b\n" "${COLOR_VERBOSE}" "${RESET}"
export COLOR_DEBUG="${BLUE_BRIGHT}"
[[ "${DEBUG}" == "${TRUE}" ]] && printf "%bColor Debug: BLUE_BRIGHT%b\n" "${COLOR_DEBUG}" "${RESET}"
export COLOR_INFO="${GREEN}"
[[ "${DEBUG}" == "${TRUE}" ]] && printf "%bColor Info: GREEN%b\n" "${COLOR_INFO}" "${RESET}"
export COLOR_WARNING="${YELLOW_BOLD}"
[[ "${DEBUG}" == "${TRUE}" ]] && printf "%bColor Warning: YELLOW_BOLD%b\n" "${COLOR_WARNING}" "${RESET}"
export COLOR_ERROR="${RED_BRIGHT}"
[[ "${DEBUG}" == "${TRUE}" ]] && printf "%bColor Error: RED_BRIGHT%b\n" "${COLOR_ERROR}" "${RESET}"
export COLOR_CRITICAL="${WHITE_ON_RED}"
[[ "${DEBUG}" == "${TRUE}" ]] && printf "%bColor Critical: WHITE_ON_RED%b\n" "${COLOR_CRITICAL}" "${RESET}"
export COLOR_FATAL="${WHITE_BOLD_BRIGHT_ON_RED}"
[[ "${DEBUG}" == "${TRUE}" ]] && printf "%bColor Fatal: WHITE_BOLD_BRIGHT_ON_RED%b\n" "${COLOR_FATAL}" "${RESET}"

# Create log level colors array
declare -a LOG_COLORS=("${COLOR_TRACE}" "${COLOR_VERBOSE}" "${COLOR_DEBUG}" "${COLOR_INFO}" "${COLOR_WARNING}" "${COLOR_ERROR}" "${COLOR_CRITICAL}" "${COLOR_FATAL}")


#####################################################################################################################################################################################################
# Define Label and Number Constants for Logging Levels
#####################################################################################################################################################################################################
TRACE_NUM=1
VERBOSE_NUM=5
DEBUG_NUM=10
INFO_NUM=20
WARNING_NUM=30
ERROR_NUM=40
CRITICAL_NUM=50
FATAL_NUM=60

declare -a LOG_LABELS=("[TRACE]" "[VERBOSE]" "[DEBUG]" "[INFO]" "[WARNING]" "[ERROR]" "[CRITICAL]" "[FATAL]")
declare -a LOG_NUMBERS=("${TRACE_NUM}" "${VERBOSE_NUM}" "${DEBUG_NUM}" "${INFO_NUM}" "${WARNING_NUM}" "${ERROR_NUM}" "${CRITICAL_NUM}" "${FATAL_NUM}")

export LOG_LEVEL="${DEFAULT_LEVEL}"         # Set log level to the default level
export LOG_LEVEL_NUM="${LOG_NUMBERS[${LOG_LEVEL}]}"


#####################################################################################################################################################################################################
# Setup Environment for logging line numbers and function names
#####################################################################################################################################################################################################
SCRIPT_NAME_ID="1"
LINE_NO_ID="0"
FUNC_NAME_ID="1"


#####################################################################################################################################################################################################
# # Define Logging Helper functions
#####################################################################################################################################################################################################
function logger() {
    local LOG_PARENT="${1}"
    local LOG_LINE="${2}"
    local LOG_FUNC="${3}"
    local LOG_LABEL="${4}"
    local LOG_MESSAGE="${5}"
    local LOG_COLOR="${6}"
    printf "%b%-21s %-28s %-23s %-11s %s%b\n" ${LOG_COLOR} "($(date +%F_%T))" "${LOG_PARENT}:($LOG_LINE):" "${LOG_FUNC}:" "${LOG_LABEL}" "${LOG_MESSAGE}" ${RESET} | tee -a "${LOG_FILE}" 2>&1
    return "${TRUE}"
}

echo "logging.conf 56"
function debug_flag_matters() {
    local LOG_LEVEL_NUM="${1}"
    [[ "${DEBUG}" == "${TRUE}" ]] && (( LOG_LEVEL_NUM >= DEBUG_NUM )) && return "${TRUE}" || return "${FALSE}"
}

echo "logging.conf 57"
function display_level_matters() {
    local LOG_LEVEL_NUM="${1}"
    local DISPLAY_LEVEL_NUM="${2}"
    (( LOG_LEVEL_NUM <= DISPLAY_LEVEL_NUM )) && return "${TRUE}" || return "${FALSE}"
}

echo "logging.conf 58"
function evaluate_log_level() {
    local DISPLAY_LEVEL_NUM="${1}"
    local LOG_LEVEL_NUM="${2}"
    ( debug_flag_matters "${LOG_LEVEL_NUM}" || display_level_matters "${LOG_LEVEL_NUM}" "${DISPLAY_LEVEL_NUM}" ) && return "${TRUE}" || return "${FALSE}"
}


#####################################################################################################################################################################################################
# Define custom level logging functions
#####################################################################################################################################################################################################
function log_trace() {
    local MESSAGE="$1"
    [[ "$2" == "" ]] && EXIT_STATUS="${EXIT_TRACE}" || EXIT_STATUS="$2"
    evaluate_log_level "${TRACE_NUM}" "${LOG_NUMBERS[${LOG_LEVEL}]}" || return "${EXIT_STATUS}"
    local CALLING_SCRIPT="$(basename "$(realpath ${BASH_SOURCE[${SCRIPT_NAME_ID}]})")"
    local CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
    local CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
    local COLOR_CODE="${LOG_COLORS[${TRACE_LEVEL}]}"
    local LOG_LABEL="${LOG_LABELS[${LOG_LEVEL}]}"
    logger "${CALLING_SCRIPT}" "${CALLING_LINE}" "${CALLING_FUNC}" "${LOG_LABEL}" "${MESSAGE}" "${COLOR_CODE}"
    [[ "${DEBUG}" == "${TRUE}" ]] && exit "${EXIT_STATUS}" || return "${EXIT_STATUS}"
}

function log_verbose() {
    local MESSAGE="$1"
    [[ "$2" == "" ]] && EXIT_STATUS="${EXIT_VERBOSE}" || EXIT_STATUS="$2"
    evaluate_log_level "${VERBOSE_NUM}" "${LOG_NUMBERS[${LOG_LEVEL}]}" || return "${EXIT_STATUS}"
    local CALLING_SCRIPT="$(basename "$(realpath ${BASH_SOURCE[${SCRIPT_NAME_ID}]})")"
    local CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
    local CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
    local COLOR_CODE="${LOG_COLORS[${VERBOSE_LEVEL}]}"
    local LOG_LABEL="${LOG_LABELS[${LOG_LEVEL}]}"
    logger "${CALLING_SCRIPT}" "${CALLING_LINE}" "${CALLING_FUNC}" "${LOG_LABEL}" "${MESSAGE}" "${COLOR_CODE}"
    [[ "${DEBUG}" == "${TRUE}" ]] && exit "${EXIT_STATUS}" || return "${EXIT_STATUS}"
}

function log_debug() {
    local MESSAGE="$1"
    [[ "$2" == "" ]] && EXIT_STATUS="${EXIT_DEBUG}" || EXIT_STATUS="$2"
    evaluate_log_level "${DEBUG_NUM}" "${LOG_NUMBERS[${LOG_LEVEL}]}" || return "${EXIT_STATUS}"
    local CALLING_SCRIPT="$(basename "$(realpath ${BASH_SOURCE[${SCRIPT_NAME_ID}]})")"
    local CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
    local CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
    local COLOR_CODE="${LOG_COLORS[${DEBUG_LEVEL}]}"
    local LOG_LABEL="${LOG_LABELS[${LOG_LEVEL}]}"
    logger "${CALLING_SCRIPT}" "${CALLING_LINE}" "${CALLING_FUNC}" "${LOG_LABEL}" "${MESSAGE}" "${COLOR_CODE}"
    [[ "${DEBUG}" == "${TRUE}" ]] && exit "${EXIT_STATUS}" || return "${EXIT_STATUS}"
}

function log_info() {
    local MESSAGE="$1"
    [[ "$2" == "" ]] && EXIT_STATUS="${EXIT_INFO}" || EXIT_STATUS="$2"
    evaluate_log_level "${INFO_NUM}" "${LOG_NUMBERS[${LOG_LEVEL}]}" || return "${EXIT_STATUS}"
    local CALLING_SCRIPT="$(basename "$(realpath ${BASH_SOURCE[${SCRIPT_NAME_ID}]})")"
    local CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
    local CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
    local COLOR_CODE="${LOG_COLORS[${INFO_LEVEL}]}"
    local LOG_LABEL="${LOG_LABELS[${INFO_LEVEL}]}"
    logger "${CALLING_SCRIPT}" "${CALLING_LINE}" "${CALLING_FUNC}" "${LOG_LABEL}" "${MESSAGE}" "${COLOR_CODE}"
    [[ "${DEBUG}" == "${TRUE}" ]] && exit "${EXIT_STATUS}" || return "${EXIT_STATUS}"
}

function log_warning() {
    local MESSAGE="$1"
    [[ "$2" == "" ]] && EXIT_STATUS="${EXIT_WARNING}" || EXIT_STATUS="$2"
    evaluate_log_level "${WARNING_NUM}" "${LOG_NUMBERS[${LOG_LEVEL}]}" || return "${EXIT_STATUS}"
    local CALLING_SCRIPT="$(basename "$(realpath ${BASH_SOURCE[${SCRIPT_NAME_ID}]})")"
    local CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
    local CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
    local COLOR_CODE="${LOG_COLORS[${WARNING_LEVEL}]}"
    local LOG_LABEL="${LOG_LABELS[${WARNING_LEVEL}]}"
    logger "${CALLING_SCRIPT}" "${CALLING_LINE}" "${CALLING_FUNC}" "${LOG_LABEL}" "${MESSAGE}" "${COLOR_CODE}"
    [[ "${DEBUG}" == "${TRUE}" ]] && exit "${EXIT_STATUS}" || return "${EXIT_STATUS}"
}

function log_error() {
    local MESSAGE="$1"
    [[ "$2" == "" ]] && EXIT_STATUS="${EXIT_ERROR}" || EXIT_STATUS="$2"
    [[ "$3" == "" ]] && TERM_STATUS="${TERM_ERROR}" || TERM_STATUS="$3"
    evaluate_log_level "${ERROR_NUM}" "${LOG_NUMBERS[${LOG_LEVEL}]}" || return "${EXIT_STATUS}"
    local CALLING_SCRIPT="$(basename "$(realpath ${BASH_SOURCE[${SCRIPT_NAME_ID}]})")"
    local CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
    local CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
    local COLOR_CODE="${LOG_COLORS[${ERROR_LEVEL}]}"
    local LOG_LABEL="${LOG_LABELS[${ERROR_LEVEL}]}"
    logger "${CALLING_SCRIPT}" "${CALLING_LINE}" "${CALLING_FUNC}" "${LOG_LABEL}" "${MESSAGE}" "${COLOR_CODE}"
    [[ "${TERM_STATUS}" == "${TRUE}" ]] && set -e && exit "${EXIT_STATUS}"
    [[ "${DEBUG}" == "${TRUE}" ]] && exit "${EXIT_STATUS}" || return "${EXIT_STATUS}"
}

function log_critical() {
    local MESSAGE="$1"
    [[ "$2" == "" ]] && EXIT_STATUS="${EXIT_CRITICAL}" || EXIT_STATUS="$2"
    [[ "$3" == "" ]] && TERM_STATUS="${TERM_CRITICAL}" || TERM_STATUS="$3"
    evaluate_log_level "${CRITICAL_NUM}" "${LOG_NUMBERS[${LOG_LEVEL}]}" || return "${EXIT_STATUS}"
    local CALLING_SCRIPT="$(basename "$(realpath ${BASH_SOURCE[${SCRIPT_NAME_ID}]})")"
    local CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
    local CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
    local COLOR_CODE="${LOG_COLORS[${CRITICAL_LEVEL}]}"
    local LOG_LABEL="${LOG_LABELS[${CRITICAL_LEVEL}]}"
    logger "${CALLING_SCRIPT}" "${CALLING_LINE}" "${CALLING_FUNC}" "${LOG_LABEL}" "${MESSAGE}" "${COLOR_CODE}"
    [[ "${TERM_STATUS}" == "${TRUE}" ]] && set -e && exit "${EXIT_STATUS}"
    [[ "${DEBUG}" == "${TRUE}" ]] && exit "${EXIT_STATUS}" || return "${EXIT_STATUS}"
}

function log_fatal() {
    local MESSAGE="$1"
    [[ "$2" == "" ]] && EXIT_STATUS="${EXIT_FATAL}" || EXIT_STATUS="$2"
    [[ "$3" == "" ]] && TERM_STATUS="${TERM_FATAL}" || TERM_STATUS="$3"
    evaluate_log_level "${FATAL_NUM}" "${LOG_NUMBERS[${LOG_LEVEL}]}" || return "${EXIT_STATUS}"
    local CALLING_SCRIPT="$(basename "$(realpath ${BASH_SOURCE[${SCRIPT_NAME_ID}]})")"
    local CALLING_LINE="${BASH_LINENO[${LINE_NO_ID}]}"
    local CALLING_FUNC="${FUNCNAME[${FUNC_NAME_ID}]}"
    local COLOR_CODE="${LOG_COLORS[${FATAL_LEVEL}]}"
    local LOG_LABEL="${LOG_LABELS[${FATAL_LEVEL}]}"
    logger "${CALLING_SCRIPT}" "${CALLING_LINE}" "${CALLING_FUNC}" "${LOG_LABEL}" "${MESSAGE}" "${COLOR_CODE}"
    [[ "${TERM_STATUS}" == "${TRUE}" ]] && set -e && exit "${EXIT_STATUS}"
    [[ "${DEBUG}" == "${TRUE}" ]] && exit "${EXIT_STATUS}" || return "${EXIT_STATUS}"
}


#####################################################################################################################################################################################################
# Set the tab size for the logging functions
#####################################################################################################################################################################################################
export tabs="${TAB_SIZE}"


#####################################################################################################################################################################################################
# Export logging functions to calling script
#####################################################################################################################################################################################################
export -f log_trace
export -f log_verbose
export -f log_debug
export -f log_info
export -f log_warning
export -f log_error
export -f log_critical
export -f log_fatal

if [[ "${DEBUG}" == "${TRUE}" ]]; then
    log_trace     "Logging functions exported: I am Trace!"
    log_verbose   "Logging functions exported: I am Verbose!"
    log_debug     "Logging functions exported: I am Debug!"
    log_info      "Logging functions exported: I am Info!"
    log_warning   "Logging functions exported: I am Warning!"
    log_error     "Logging functions exported: I am Error!"    "${TRUE}" "${FALSE}"  # These extra params cause the log function to return "${TRUE}" and not terminate
    log_critical  "Logging functions exported: I am Critical!" "${TRUE}" "${FALSE}"  # These extra params cause the log function to return "${TRUE}" and not terminate
    log_fatal     "Logging functions exported: I am Fatal!"    "${TRUE}" "${FALSE}"  # These extra params cause the log function to return "${TRUE}" and not terminate
fi

[[ "${DEBUG}" == "${TRUE}" ]] && exit "${TRUE}" || return "${TRUE}"

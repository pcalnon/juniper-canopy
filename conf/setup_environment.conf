#!/usr/bin/env bash
#####################################################################################################################################################################################################
# Project:       Juniper
# Sub-Project:   JuniperCanopy
# Application:   juniper_canopy
# Purpose:       Monitoring and Diagnostic Frontend for Cascade Correlation Neural Network
#
# Author:        Paul Calnon
# Version:       0.1.4 (0.7.3)
# File Name:     setup_environment.conf
# File Path:     <Project>/<Sub-Project>/<Application>/conf/
#
# Date:          2025-10-11
# Last Modified: 2026-01-04
#
# License:       MIT License
# Copyright:     Copyright (c) 2024,2025,2026 Paul Calnon
#
# Description:
#    This script sets up the development environment for the Juniper Canopy application.
#
#####################################################################################################################################################################################################
# Notes:
#     Juniper Canopy Environment Setup Script
#     This script sets up the development environment for the Juniper Canopy application
#
########################################################################################################)#############################################################################################
# References:
#
#####################################################################################################################################################################################################
# TODO :
#
#####################################################################################################################################################################################################
# COMPLETED:
#
#####################################################################################################################################################################################################


#####################################################################################################################################################################################################
# Only Source this conf file Once
#####################################################################################################################################################################################################
if [[ "${SETUP_ENVIRONMENT_SOURCED}" != "${TRUE}" ]]; then
    export SETUP_ENVIRONMENT_SOURCED="${TRUE}"
else
    log_warning "setup_environment.conf already sourced.  Skipping re-source."
    return $(( TRUE ))
fi


#####################################################################################################################################################################################################
# Define local Configuration constants
#####################################################################################################################################################################################################
log_trace "Define local Configuration constants"
export PROJECT_NAME="Juniper Canopy"                                          && log_verbose "PROJECT_NAME: ${PROJECT_NAME}"
export ENV_NAME="JuniperPython"                                               && log_verbose "ENV_NAME: ${ENV_NAME}"
export PROJECT_DIR="${HOME}/Development/python/JuniperCanopy/juniper_canopy"  && log_verbose "PROJECT_DIR: ${PROJECT_DIR}"


#####################################################################################################################################################################################################
# Colors for output
#####################################################################################################################################################################################################
log_trace "Define Colors for output"
export RED='\033[0;31m'
export GREEN='\033[0;32m'
export YELLOW='\033[1;33m'
export BLUE='\033[0;34m'
export NC='\033[0m' # No Color


#####################################################################################################################################################################################################
# Define Script Constants
#####################################################################################################################################################################################################
log_trace "Define Script Constants"
export BASH_CONFIG=""                                                         && log_verbose "BASH_CONFIG: ${BASH_CONFIG}"
export LINUX="Linux"                                                          && log_verbose "LINUX: ${LINUX}"
export MACOS="Darwin"                                                         && log_verbose "MACOS: ${MACOS}"
export COMMENT_REGEX="^[[:space:]]*#.*$"                                      && log_verbose "COMMENT_REGEX: ${COMMENT_REGEX}"
export CONDA_CMD="conda"                                                      && log_verbose "CONDA_CMD: ${CONDA_CMD}"
export MAMBA_CMD="mamba"                                                      && log_verbose "MAMBA_CMD: ${MAMBA_CMD}"
export CONDA_OFFSET="2"                                                       && log_verbose "CONDA_OFFSET: ${CONDA_OFFSET}"
export MAMBA_OFFSET="3"                                                       && log_verbose "MAMBA_OFFSET: ${MAMBA_OFFSET}"
export USE_CONDA="${FALSE}"                                                   && log_verbose "USE_CONDA: ${USE_CONDA}"
# USE_CONDA="${TRUE}"
export USE_MAMBA="$(( (USE_CONDA + 1) % 2 ))"                                 && log_verbose "USE_MAMBA: ${USE_MAMBA}"
# shellcheck disable=SC2155
export OS_TYPE="$(uname -s)"                                                  && log_verbose "OS_TYPE: ${OS_TYPE}"


#####################################################################################################################################################################################################
# Define Environment Variables for .env file
#####################################################################################################################################################################################################
log_trace "Define Environment Variables for .env file"
export DEV_ENV="development"
ENV_DOT_FILE_NAME=".env"
ENV_DOT_FILE_PATH="${APP_DIR}"
export ENV_DOT_FILE="${ENV_DOT_FILE_PATH}/${ENV_DOT_FILE_NAME}"
export CASCOR_ENV="${DEV_ENV}"
export CASCOR_DEBUG="${TRUE}"
export CASCOR_LOG_LEVEL="${DEBUG_LEVEL}"
export CASCOR_CONSOLE_LOG_LEVEL="${INFO_LEVEL}"
export CASCOR_FILE_LOG_LEVEL="${DEBUG_LEVEL}"
export CASCOR_CONFIG_PATH="${CONF_DIR}"
export CASCOR_CONFIG_FILE_NAME="app_config.yaml"
export CASCOR_CONFIG_FILE="${CASCOR_CONFIG_PATH}/${CASCOR_CONFIG_FILE_NAME}"
export OMP_NUM_THREADS="4"
export MKL_NUM_THREADS="4"
export NUMBA_NUM_THREADS="4"
export CASCOR_HOST="127.0.0.1"
export CASCOR_PORT="8050"


#####################################################################################################################################################################################################
# Define Content for .env Environment file
#####################################################################################################################################################################################################
log_trace "Define Content for .env Environment file"
export ENV_DOT_FILE_CONTENT="
# Juniper Canopy Environment Variables
CASCOR_ENV=\"${CASCOR_ENV}\"
CASCOR_DEBUG=\"${TRUE}\"
CASCOR_LOG_LEVEL=\"${CASCOR_LOG_LEVEL}\"
CASCOR_CONSOLE_LOG_LEVEL=\"${CASCOR_CONSOLE_LOG_LEVEL}\"
CASCOR_FILE_LOG_LEVEL=\"${CASCOR_FILE_LOG_LEVEL}\"
CASCOR_CONFIG_PATH=\"${CASCOR_CONFIG_PATH}\"
CASCOR_CONFIG_FILE=\"${CASCOR_CONFIG_FILE}\"

# Performance settings
OMP_NUM_THREADS=\"${OMP_NUM_THREADS}\"
MKL_NUM_THREADS=\"${MKL_NUM_THREADS}\"
NUMBA_NUM_THREADS=\"${NUMBA_NUM_THREADS}\"

# Application settings
CASCOR_HOST=\"${CASCOR_HOST}\"
CASCOR_PORT=\"${CASCOR_PORT}\"
"


#####################################################################################################################################################################################################
# Create .env file with Content defined above
#####################################################################################################################################################################################################
echo -e "${ENV_DOT_FILE_CONTENT}" > "${ENV_DOT_FILE}"


#####################################################################################################################################################################################################
# Define Common, Top-Level Constants needed to Create a simple Python test script
#####################################################################################################################################################################################################
log_trace "Define Common, Top-Level Constants needed to Create a simple Python test script"
export PY_TRUE="True"
export PY_FALSE="False"
export ENV_TEST_SCRIPT_NAME="test_setup.py"
export ENV_TEST_SCRIPT_PATH="${UTIL_DIR}"
export ENV_TEST_SCRIPT="${ENV_TEST_SCRIPT_PATH}/${ENV_TEST_SCRIPT_NAME}"
export ENV_TEST_SCRIPT_SHEBANG="#!/usr/bin/env python3"
export ENV_TEST_SCRIPT_DESC="\
\"\"\"
Simple Python test script to verify Juniper Canopy Test Environment setup
\"\"\"\
"
export PACKAGE_IMPORT_LABEL="Package imports"
export DIRECTORY_STRUCTURE_LABEL="Directory structure"
export LOGGING_FRAMEWORK_LABEL="Logging framework"
export ENV_TEST_IMPORTS_FN="test_imports"
export ENV_TEST_LOGGING_FN="test_logging"
export ENV_TEST_DIRS_FN="test_directories"
export TESTING_ENVIRONMENT_VALIDATION_SCRIPTS="[\
(\"$PACKAGE_IMPORTS_LABEL\", ${ENV_TEST_IMPORTS_FN}), \
(\"$DIRECTORY_STRUCTURE_LABEL\", ${ENV_TEST_DIRS_FN}), \
(\"$LOGGING_FRAMEWORK_LABEL\", ${ENV_TEST_LOGGING_FN}),\
]"
export ENV_TEST_SCRIPT_RESULT_HEADER="\
print(\"=\" * 50)
print(\"Juniper Canopy Setup Verification\")
print(\"=\" * 50)
print(f\"Python version: {sys.version}\")
print(f\"Test time: {datetime.now()}\")
print()\
"

#####################################################################################################################################################################################################
# Define Constants for the test imports function
#####################################################################################################################################################################################################
log_trace "Define Constants for the test imports function"
export ENV_TEST_IMPORTS_PACKAGE_DOCSTRING="\
\"\"\"
\tTest that required packages are installed.
\t\"\"\"\
"
export ENV_TEST_PACKAGE_IMPORTS_HEADER="print(\"Testing package imports...\")"
export ENV_TEST_SCRIPT_IMPORTS="\
import sys
import os
from datetime import datetime
"
export ENV_TEST_IMPORTS_PACKAGES="[\
\"dash\", \
\"fastapi\", \
\"plotly\", \
\"redis\", \
\"torch\", \
\"numpy\", \
\"pandas\", \
\"yaml\", \
\"colorama\", \
\"psutil\"\
]"
export ENV_TEST_IMPORTS_PACKAGE_FOUND="print(f\"  ${GREEN}‚úì${NC} {package}\")"
export ENV_TEST_IMPORTS_PACKAGE_MISSING="print(f\"  ${RED}‚úó${NC} {package}: {e}\")"


#####################################################################################################################################################################################################
# Define Constants for the test logging function
#####################################################################################################################################################################################################
log_trace "Define Constants for the test logging function"
export ENV_TEST_LOGGING_FRAME_DOCSTRING="\
\"\"\"
\tTest the logging framework.
\t\"\"\"\
"
export ENV_TEST_LOGGING_FRAME_HEADER="print(\"\\nTesting logging framework...\")"
export ENV_TEST_LOGGING_SYSTEM_TEST="system_logger.info(\"System logger test message\")"
export ENV_TEST_LOGGING_TRAINING_TEST="training_logger.info(\"Training logger test message\")"
export ENV_TEST_LOGGING_FRAME_FOUND="print(f\"  ${GREEN}‚úì${NC} Logging framework functional\")"
export ENV_TEST_LOGGING_FRAME_MISSING="print(f\"  ${RED}‚úó${NC} Logging framework error: {e}\")"


#####################################################################################################################################################################################################
# Define Constants for the test directories function
#####################################################################################################################################################################################################
log_trace "Define Constants for the test directories function"
export ENV_TEST_DIRS_FN_DOCSTRING="\
\"\"\"
\tTest that required directories exist.
\t\"\"\"\
"
export ENV_TEST_DIR_STRUCTURE_HEADER="print(\"\\nTesting directory structure...\")"
export ENV_TEST_REQUIRED_DIRS="[\
\"${CONF_DIR_NAME}\", \
\"${NOTES_DIR_NAME}\", \
\"${SRC_DIR_NAME}\", \
\"${DATA_DIR_NAME}\", \
\"${LOGS_DIR_NAME}\", \
\"${IMAGES_DIR_NAME}\", \
\"${UTIL_DIR_NAME}\"\
]"
export ENV_TEST_DIR_STRUCTURE_FOUND="print(f\"  ${GREEN}‚úì${NC} {dir_name}/\")"
export ENV_TEST_DIR_STRUCTURE_MISSING="print(f\"  ${RED}‚úó${NC} {dir_name}/ (missing)\")"


#####################################################################################################################################################################################################
# Define Constants for the main test function
#####################################################################################################################################################################################################
log_trace "Define Constants for the main test function"
export ENV_TEST_MAIN_CURRENT_TEST="print(f\"Running Test: {test_name}...\")"
export ENV_TEST_MAIN_RESULT_NUMBERS="\
print(\"\\n\" + \"=\" * 50)
\tprint(f\"Tests passed: {passed}/{len(tests)}\")
"
export ENV_TEST_MAIN_RESULT_SUCCESS="\
print(\"üéâ Setup verification completed successfully!\")
\t\tprint(\"\nNext steps:\")
\t\tprint(\"1. Activate environment: conda activate JuniperPython\")
\t\tprint(\"2. Start development: python -m src.main\")
"
export ENV_TEST_MAIN_RESULT_FAILURE="print(\"‚ùå Some tests failed. Please check the setup.\")"


#####################################################################################################################################################################################################
# Build and Source the Function config file path
#####################################################################################################################################################################################################
log_trace "Build and Source the Function config file path"
CONF_FUNCTION_FILE_NAME="${SCRIPT_NAME%.*}${FUNCTION_CONF_INFIX}.${CONF_EXT}"
CONF_FUNCTION_FILE="${CONF_DIR}/${CONF_FUNCTION_FILE_NAME}"
RETURN_FOR_NO_FUNCTIONS_CONF_FILE="${FALSE}"
FAIL_ON_NO_FUNCTIONS_CONF_FILE="${FALSE}"

# Validate the function config file exists before attempting to source
if [[ "${FAIL_ON_NO_FUNCTIONS_CONF_FILE}" == "${TRUE}" ]]; then
    [[ "${CONF_FUNCTION_FILE}" == "" || ! -f "${CONF_FUNCTION_FILE}" ]] && log_fatal "Function config file not found: ${CONF_FUNCTION_FILE}" "${RETURN_FOR_NO_FUNCTIONS_CONF_FILE}" "${RETURN_FOR_NO_FUNCTIONS_CONF_FILE}"
fi
[[ "${CONF_FUNCTION_FILE}" == "" || ! -f "${CONF_FUNCTION_FILE}" ]] && { log_warning "Function config file not found: ${CONF_FUNCTION_FILE}" "${RETURN_FOR_NO_FUNCTIONS_CONF_FILE}"; return "${RETURN_FOR_NO_FUNCTIONS_CONF_FILE}"; }

# shellcheck disable=SC1090
source "${CONF_FUNCTION_FILE}"; SUCCESS="$?"
[[ "${SUCCESS}" != "${TRUE}" ]] && log_fatal "Failed to source the function config file: ${CONF_FUNCTION_FILE}, returned ${SUCCESS}"
log_debug "Successfully sourced the function config file: ${CONF_FUNCTION_FILE}"

return $(( TRUE ))
